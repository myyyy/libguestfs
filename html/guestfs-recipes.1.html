
<html>
<head>
<title>guestfs-recipes</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<link rel='stylesheet' href='pod.css' type='text/css' />
</head>
<body>


<ul id="index">
  <li><a href="#name">NAME</a></li>
  <li><a href="#description">DESCRIPTION</a></li>
  <li><a href="#access-a-remote-disk-image-using-guestfish">Access a remote disk image using guestfish</a></li>
  <li><a href="#audit-a-virtual-machine-for-setuid-files">Audit a virtual machine for setuid files</a></li>
  <li><a href="#audit-a-virtual-machine-for-vulnerabilities-and-security-problems">Audit a virtual machine for vulnerabilities and security problems</a></li>
  <li><a href="#change-the-background-image-in-a-windows-xp-vm">Change the background image in a Windows XP VM</a></li>
  <li><a href="#checksum-a-file-or-device-within-a-disk-image">Checksum a file or device within a disk image</a></li>
  <li><a href="#cloning-a-virtual-machine">Cloning a virtual machine</a></li>
  <li><a href="#convert-a-cd-rom-dvd-iso-to-a-tarball">Convert a CD-ROM / DVD / ISO to a tarball</a></li>
  <li><a href="#convert-from-one-format-filesystem-to-another">Convert from one format/filesystem to another</a></li>
  <li><a href="#convert-windows-dvd-to-bootable-usb-key">Convert Windows DVD to bootable USB key</a></li>
  <li><a href="#convert-xen-style-partitionless-image-to-partitioned-disk-image">Convert Xen-style partitionless image to partitioned disk image</a></li>
  <li><a href="#create-empty-disk-images">Create empty disk images</a></li>
  <li><a href="#delete-a-file-or-other-simple-file-operations-">Delete a file (or other simple file operations)</a></li>
  <li><a href="#diff-two-guests-compare-a-snapshot-to-the-current-version">Diff two guests; compare a snapshot to the current version</a></li>
  <li><a href="#disable-a-systemd-service">Disable a systemd service</a></li>
  <li><a href="#dump-raw-filesystem-content-from-inside-a-disk-image-or-vm">Dump raw filesystem content from inside a disk image or VM</a></li>
  <li><a href="#edit-grub-configuration-in-a-vm">Edit grub configuration in a VM</a></li>
  <li><a href="#export-any-directory-from-a-vm">Export any directory from a VM</a></li>
  <li><a href="#find-out-which-user-is-using-the-most-space">Find out which user is using the most space</a></li>
  <li><a href="#export-external-kernel-and-initramfs-initrd-">Export external kernel and initramfs (initrd)</a></li>
  <li><a href="#get-dhcp-address-from-a-vm">Get DHCP address from a VM</a></li>
  <li><a href="#get-the-operating-system-product-name-string">Get the operating system product name string</a></li>
  <li><a href="#get-the-default-boot-kernel-for-a-linux-vm">Get the default boot kernel for a Linux VM</a></li>
  <li><a href="#hanging-guests">Hanging guests</a></li>
  <li><a href="#hex-dumping-sectors-from-the-guest">Hex-dumping sectors from the guest</a></li>
  <li><a href="#hex-editing-sectors-in-the-guest">Hex-editing sectors in the guest</a></li>
  <li><a href="#install-packages-rpms-debian-packages-in-a-guest">Install packages (RPMs, Debian packages) in a guest</a></li>
  <li><a href="#install-packages-from-an-alternate-repository">Install packages from an alternate repository</a></li>
  <li><a href="#install-syslinux-bootloader-in-a-guest">Install SYSLINUX bootloader in a guest</a></li>
  <li><a href="#list-applications-installed-in-a-vm">List applications installed in a VM</a></li>
  <li><a href="#list-files-and-directories-in-a-vm">List files and directories in a VM</a></li>
  <li><a href="#list-services-in-a-windows-vm">List services in a Windows VM</a></li>
  <li><a href="#make-a-disk-image-sparse">Make a disk image sparse</a></li>
  <li><a href="#monitor-disk-usage-over-time">Monitor disk usage over time</a></li>
  <li><a href="#reading-the-windows-event-log-from-windows-vista-or-later-">Reading the Windows Event Log from Windows Vista (or later)</a></li>
  <li><a href="#remove-root-password-linux-">Remove root password (Linux)</a></li>
  <li><a href="#remove-administrator-password-windows-">Remove Administrator password (Windows)</a></li>
  <li><a href="#sysprepping-a-virtual-machine-windows-">Sysprepping a virtual machine (Windows)</a></li>
  <li><a href="#unpack-a-live-cd">Unpack a live CD</a></li>
  <li><a href="#uploading-and-downloading-files">Uploading and downloading files</a></li>
  <li><a href="#uploading-raw-filesystem-content">Uploading raw filesystem content</a></li>
  <li><a href="#use-libguestfs-tools-on-vmware-esx-guests">Use libguestfs tools on VMware ESX guests</a></li>
  <li><a href="#see-also">SEE ALSO</a></li>
  <li><a href="#authors">AUTHORS</a></li>
  <li><a href="#copyright">COPYRIGHT</a></li>
  <li><a href="#license">LICENSE</a></li>
  <li><a href="#bugs">BUGS</a></li>
</ul>

<h1 id="name">NAME</h1>

<p>guestfs-recipes - libguestfs, guestfish and virt tools recipes</p>

<h1 id="description">DESCRIPTION</h1>

<p>This page contains recipes for and links to things you can do using libguestfs, <a href="guestfish.1.html">guestfish(1)</a> and the virt tools.</p>

<h1 id="access-a-remote-disk-image-using-guestfish">Access a remote disk image using guestfish</h1>

<p>If the disk image is on a remote server which is accessible using SSH, HTTP, FTP, NBD, iSCSI, or similar, then you can open it directly. See <a href="guestfish.1.html#adding-remote-storage">&quot;ADDING REMOTE STORAGE&quot; in guestfish(1)</a> for several examples. This requires libguestfs &ge; 1.22 and qemu &ge; 1.5.</p>

<h1 id="audit-a-virtual-machine-for-setuid-files">Audit a virtual machine for setuid files</h1>

<p>See: <a href="virt-ls.1.html#examples">&quot;EXAMPLES&quot; in virt-ls(1)</a>.</p>

<h1 id="audit-a-virtual-machine-for-vulnerabilities-and-security-problems">Audit a virtual machine for vulnerabilities and security problems</h1>

<p>See: <a href="https://rwmj.wordpress.com/2013/05/16/scanning-offline-guests-using-openscap-and-guestmount/#content">https://rwmj.wordpress.com/2013/05/16/scanning-offline-guests-using-openscap-and-guestmount/#content</a></p>

<h1 id="change-the-background-image-in-a-windows-xp-vm">Change the background image in a Windows XP VM</h1>

<p>The links below explain how to use <a href="guestfish.1.html">guestfish(1)</a> to change the background image for a user of a Windows XP VM. Unfortunately the technique appears to be substantially different for each version of Windows.</p>

<p><a href="https://lists.fedoraproject.org/pipermail/virt/2011-May/002655.html">https://lists.fedoraproject.org/pipermail/virt/2011-May/002655.html</a> <a href="https://lists.fedoraproject.org/pipermail/virt/2011-May/002658.html">https://lists.fedoraproject.org/pipermail/virt/2011-May/002658.html</a></p>

<h1 id="checksum-a-file-or-device-within-a-disk-image">Checksum a file or device within a disk image</h1>

<p>To checksum a whole device, or a partition, LV etc within a disk image:</p>

<pre><code> guestfish --ro -a disk.img run : checksum-device md5 /dev/sda1</code></pre>

<p>Replace <code>md5</code> with the type of checksum you want. See <a href="guestfs.3.html#guestfs_checksum_device">&quot;guestfs_checksum_device&quot; in guestfs(3)</a> for a list of supported types.</p>

<p><i>/dev/sda1</i> means &quot;the first partition&quot;. You could use <i>/dev/sda</i> to checksum the whole disk image, or the name of a logical volume or RAID device.</p>

<p>To checksum a single file:</p>

<pre><code> guestfish --ro -a disk.img -i checksum sha256 /etc/passwd</code></pre>

<p>or for a Windows guest:</p>

<pre><code> guestfish --ro -a disk.img -i \
   checksum sha256 &#39;win:\windows\system32\config\SOFTWARE&#39;</code></pre>

<h1 id="cloning-a-virtual-machine">Cloning a virtual machine</h1>

<p>Use a combination of tools like <a href="http://man.he.net/man1/cp">cp(1)</a>, <a href="http://man.he.net/man1/dd">dd(1)</a>, and virt tools like <a href="virt-sysprep.1.html">virt-sysprep(1)</a>, <a href="virt-sparsify.1.html">virt-sparsify(1)</a> and <a href="virt-resize.1.html">virt-resize(1)</a>.</p>

<p>For more details, see: <a href="virt-sysprep.1.html#copying-and-cloning">&quot;COPYING AND CLONING&quot; in virt-sysprep(1)</a>.</p>

<h1 id="convert-a-cd-rom-dvd-iso-to-a-tarball">Convert a CD-ROM / DVD / ISO to a tarball</h1>

<p>This converts input <i>cd.iso</i> to output <i>cd.tar.gz</i>:</p>

<pre><code> guestfish --ro -a cd.iso -m /dev/sda tgz-out / cd.tar.gz</code></pre>

<p>To export just a subdirectory, eg. <i>/files</i>, do:</p>

<pre><code> guestfish --ro -a cd.iso -m /dev/sda tgz-out /files cd.tar.gz</code></pre>

<h1 id="convert-from-one-format-filesystem-to-another">Convert from one format/filesystem to another</h1>

<p>If you have a data disk in one format / filesystem / partition / volume manager, you can convert it another using this technique.</p>

<p>In this example, we start with a data disk that has a single partition containing a filesystem, and we want to create another disk that contains the same files but on an ext3 filesystem embedded in a logical volume on a sparse raw-format disk.</p>

<p>First create the formatted-but-empty target disk:</p>

<pre><code> truncate -s 10G target.img
 virt-format -a target.img --partition=mbr --lvm --filesystem=ext3</code></pre>

<p>Now, pipe two guestfish instances together to transfer the old data to the new disk:</p>

<pre><code> guestfish --ro -a source.img -m /dev/sda1  -- tar-out / - | \
 guestfish --rw -a target.img -m /dev/VG/LV -- tar-in - /</code></pre>

<p>To browse the final disk image, do:</p>

<pre><code> guestfish --ro -a target.img -m /dev/VG/LV
 &gt;&lt;fs&gt; ll /</code></pre>

<p>This technique is quite powerful, allowing you for example to split up source directories over the target filesystems.</p>

<p>Note this won&#39;t work (at least, not directly) for bootable virtual machine disks because it doesn&#39;t copy over the boot loader.</p>

<h1 id="convert-windows-dvd-to-bootable-usb-key">Convert Windows DVD to bootable USB key</h1>

<p><a href="http://rwmj.wordpress.com/2013/05/09/tip-convert-a-windows-dvd-iso-to-a-bootable-usb-key-using-guestfish/#content">http://rwmj.wordpress.com/2013/05/09/tip-convert-a-windows-dvd-iso-to-a-bootable-usb-key-using-guestfish/#content</a></p>

<h1 id="convert-xen-style-partitionless-image-to-partitioned-disk-image">Convert Xen-style partitionless image to partitioned disk image</h1>

<p>Xen disk images are often partitionless, meaning that the filesystem starts directly at the beginning of the disk with no partition table. You can in fact use these directly in KVM (provided the guest isn&#39;t Windows), but some people like to convert them to regular partitioned disk images, and this is required for Windows guests. Here is how to use guestfish to do this:</p>

<pre><code> guestfish
 &gt;&lt;fs&gt; add-ro input.img
 &gt;&lt;fs&gt; sparse output.img 10G     # adjust the output size
 &gt;&lt;fs&gt; run
 # Create a partition table on the output disk:
 &gt;&lt;fs&gt; part-init /dev/sdb mbr
 &gt;&lt;fs&gt; part-add /dev/sdb p 2048 -2048
 # Copy the data to the target partition:
 &gt;&lt;fs&gt; copy-device-to-device /dev/sda /dev/sdb1 sparse:true
 # Optionally resize the target filesystem.  Use ntfsresize
 # for Windows guests:
 &gt;&lt;fs&gt; resize2fs /dev/sdb1</code></pre>

<p>Such a disk image won&#39;t be directly bootable. You may need to boot it with an external kernel and initramfs (see below). Or you can use the guestfish commands <code>syslinux</code> or <code>extlinux</code> to install a SYSLINUX bootloader.</p>

<h1 id="create-empty-disk-images">Create empty disk images</h1>

<p>The <a href="virt-format.1.html">virt-format(1)</a> tool can do this directly.</p>

<p>Use <a href="virt-make-fs.1.html">virt-make-fs(1)</a> to create a disk image with content. This can also create some standard disk images such as virtual floppy devices (VFDs).</p>

<p>You can also use the <a href="guestfish.1.html">guestfish(1)</a> <i>-N</i> option to create empty disk images. The useful guide below explains the options available.</p>

<p><a href="https://rwmj.wordpress.com/2010/09/08/new-guestfish-n-options-in-1-5-9/#content">https://rwmj.wordpress.com/2010/09/08/new-guestfish-n-options-in-1-5-9/#content</a></p>

<p><a href="virt-builder.1.html">virt-builder(1)</a> can create minimal guests.</p>

<h1 id="delete-a-file-or-other-simple-file-operations-">Delete a file (or other simple file operations)</h1>

<p>Use guestfish. To delete a file:</p>

<pre><code> guestfish -a disk.img -i rm /file/to/delete</code></pre>

<p>To touch a file (bring it up to date or create it):</p>

<pre><code> guestfish -a disk.img -i touch /file/to/touch</code></pre>

<p>To stat a file. Since this is a read-only operation, we can make it safer by adding the <i>--ro</i> flag.</p>

<pre><code> guestfish --ro -a disk.img -i stat /file/to/stat</code></pre>

<p>There are dozens of these commands. See <a href="guestfish.1.html">guestfish(1)</a> or the output of <code>guestfish -h</code></p>

<h1 id="diff-two-guests-compare-a-snapshot-to-the-current-version">Diff two guests; compare a snapshot to the current version</h1>

<p>Since libguestfs &ge; 1.26, use <a href="virt-diff.1.html">virt-diff(1)</a> to look for differences between two guests (for example if they were originally cloned from the same source), or between two snapshots from the same guest. In earlier versions of libguestfs, use <a href="virt-ls.1.html">virt-ls(1)</a>.</p>

<h1 id="disable-a-systemd-service">Disable a systemd service</h1>

<p>The following is the equivalent of <code>systemctl mask ...</code>. To disable the <code>cloud-init</code> service so it doesn&#39;t start at next boot:</p>

<pre><code> guestfish -a disk.img -i \
     ln-sf /dev/null /etc/systemd/system/cloud-init.service</code></pre>

<p>To disable tmp-on-tmpfs:</p>

<pre><code> guestfish -a disk.img -i \
     ln-sf /dev/null /etc/systemd/system/tmp.mount</code></pre>

<p>One problem with the commands above is there is no feedback if you get the name of the service you are trying to mask wrong. But you can use <a href="virt-ls.1.html">virt-ls(1)</a> to list the available systemd services like this:</p>

<pre><code> virt-ls -a /tmp/fedora-19.img -R /lib/systemd/system</code></pre>

<h1 id="dump-raw-filesystem-content-from-inside-a-disk-image-or-vm">Dump raw filesystem content from inside a disk image or VM</h1>

<p>You can use the <a href="guestfish.1.html">guestfish(1)</a> <code>download</code> command to extract the raw filesystem content from any filesystem in a disk image or a VM (even one which is encrypted or buried inside an LV or RAID device):</p>

<pre><code> guestfish --ro -a disk.img run : download /dev/sda1 sda1.img

 guestfish --ro -d Guest run : download /dev/vg_guest/lv_root lv.img</code></pre>

<p>To download to stdout, replace the filename with a <code>-</code> character:</p>

<pre><code> guestfish --ro -a disk.img run : download /dev/sda1 - | gzip &gt; sda1.gz</code></pre>

<p>To list the filesystems in a disk image, use <a href="virt-filesystems.1.html">virt-filesystems(1)</a>.</p>

<p>See also <a href="#uploading-raw-filesystem-content">&quot;Uploading raw filesystem content&quot;</a>.</p>

<h1 id="edit-grub-configuration-in-a-vm">Edit grub configuration in a VM</h1>

<p>You can use this to:</p>

<ul>

<li><p>Fix a virtual machine that does not boot.</p>

</li>
<li><p>Change which kernel is used to boot the VM.</p>

</li>
<li><p>Change kernel command line options.</p>

</li>
</ul>

<p>Use <a href="virt-edit.1.html">virt-edit(1)</a> to edit the grub configuration:</p>

<pre><code> virt-edit -d BrokenGuest /boot/grub2/grub.cfg</code></pre>

<p>or for general tinkering inside an unbootable VM use <a href="virt-rescue.1.html">virt-rescue(1)</a> like this:</p>

<pre><code> virt-rescue -d BrokenGuest</code></pre>

<h1 id="export-any-directory-from-a-vm">Export any directory from a VM</h1>

<p>To export <i>/home</i> from a VM into a local directory use <a href="virt-copy-out.1.html">virt-copy-out(1)</a>:</p>

<pre><code> virt-copy-out -d Guest /home .</code></pre>

<p>Notes:</p>

<ul>

<li><p>The final dot of the command is not a printing error. It means we want to copy out to the current directory.</p>

</li>
<li><p>This creates a directory called <code>home</code> under the current directory.</p>

</li>
</ul>

<p>If the guest is a Windows guest then you can use drive letters and backslashes, but you must prefix the path with <code>win:</code> and quote it to protect it from the shell, like this:</p>

<pre><code> virt-copy-out -d WinGuest &#39;win:c:\windows\system32\config&#39; .</code></pre>

<p>To get the output as a compressed tarball, do:</p>

<pre><code> virt-tar-out -d Guest /home - | gzip --best &gt; home.tar.gz</code></pre>

<p>Although it sounds tempting, this is usually not a reliable way to get a backup from a running guest. See the entry in the FAQ: <a href="http://libguestfs.org/FAQ.html#backup">http://libguestfs.org/FAQ.html#backup</a></p>

<h1 id="find-out-which-user-is-using-the-most-space">Find out which user is using the most space</h1>

<p>This simple script examines a Linux guest to find out which user is using the most space in their home directory:</p>

<pre><code> #!/bin/sh -
 
 set -e
 
 vm=&quot;$1&quot;
 dir=/home
 
 eval $(guestfish --ro -d &quot;$vm&quot; -i --listen)
 
 for d in $(guestfish --remote ls &quot;$dir&quot;); do
     echo -n &quot;$dir/$d&quot;
     echo -ne &#39;\t&#39;
     guestfish --remote du &quot;$dir/$d&quot;;
 done | sort -nr -k 2
 
 guestfish --remote exit</code></pre>

<h1 id="export-external-kernel-and-initramfs-initrd-">Export external kernel and initramfs (initrd)</h1>

<p>If a Linux guest doesn&#39;t have a boot loader or it is broken, then you can usually boot it using an external kernel and initramfs. In this configuration, the hypervisor acts like a bootloader, loading the kernel from the host disk into guest memory and jumping straight into the kernel.</p>

<p>However you may wonder how to get the right kernel corresponding to the disk image you have. Since libguestfs &ge; 1.24 <a href="virt-builder.1.html">virt-builder(1)</a> can get the latest kernel and corresponding initramfs for you:</p>

<pre><code> mkdir outputdir
 virt-builder --get-kernel disk.img -o outputdir
 ls -lh outputdir</code></pre>

<h1 id="get-dhcp-address-from-a-vm">Get DHCP address from a VM</h1>

<p>The link below explains the many different possible techniques for getting the last assigned DHCP address of a virtual machine.</p>

<p><a href="https://rwmj.wordpress.com/2011/03/31/tip-code-for-getting-dhcp-address-from-a-virtual-machine-disk-image/#content">https://rwmj.wordpress.com/2011/03/31/tip-code-for-getting-dhcp-address-from-a-virtual-machine-disk-image/#content</a></p>

<p>In the libguestfs source examples directory you will find the latest version of the <i>virt-dhcp-address.c</i> program.</p>

<h1 id="get-the-operating-system-product-name-string">Get the operating system product name string</h1>

<p>Save the following script into a file called <i>product-name.sh</i>:</p>

<pre><code> #!/bin/sh -
 set -e
 eval &quot;$(guestfish --ro -d &quot;$1&quot; --i --listen)&quot;
 root=&quot;$(guestfish --remote inspect-get-roots)&quot;
 guestfish --remote inspect-get-product-name &quot;$root&quot;
 guestfish --remote exit</code></pre>

<p>Make the script executable and run it on a named guest:</p>

<pre><code> # product-name.sh RHEL60x64
 Red Hat Enterprise Linux Server release 6.0 (Santiago)</code></pre>

<p>You can also use an XPath query on the <a href="virt-inspector.1.html">virt-inspector(1)</a> XML using the <code>xpath</code> command line tool or from your favourite programming language:</p>

<pre><code> # virt-inspector RHEL60x64 &gt; xml
 # xpath &#39;//product_name&#39; &lt; xml
 Found 1 nodes:
 -- NODE --
 &lt;product_name&gt;Red Hat Enterprise Linux Server release 6.0 (Santiago)&lt;/product_name&gt;</code></pre>

<h1 id="get-the-default-boot-kernel-for-a-linux-vm">Get the default boot kernel for a Linux VM</h1>

<p>The link below contains a program to print the default boot kernel for a Linux VM.</p>

<p><a href="https://rwmj.wordpress.com/2010/10/30/tip-use-augeas-to-get-the-default-boot-kernel-for-a-vm/#content">https://rwmj.wordpress.com/2010/10/30/tip-use-augeas-to-get-the-default-boot-kernel-for-a-vm/#content</a></p>

<p>It uses Augeas, and the technique is generally applicable for many different tasks, such as:</p>

<ul>

<li><p>listing the user accounts in the guest</p>

</li>
<li><p>what repositories is it configured to use</p>

</li>
<li><p>what NTP servers does it connect to</p>

</li>
<li><p>what were the boot messages last time it booted</p>

</li>
<li><p>listing who was logged in recently</p>

</li>
</ul>

<p><a href="http://augeas.net/">http://augeas.net/</a></p>

<h1 id="hanging-guests">Hanging guests</h1>

<p>There are various ways to use libguestfs to find out why a guest is hanging or unresponsive:</p>

<ol>

<li><p>Read the log files using virt-cat:</p>

<pre><code> virt-cat Guest /var/log/messages | less</code></pre>

</li>
<li><p>Read the Windows Event Log (Windows Vista or later only):</p>

<p><a href="https://rwmj.wordpress.com/2011/04/17/decoding-the-windows-event-log-using-guestfish/#content">https://rwmj.wordpress.com/2011/04/17/decoding-the-windows-event-log-using-guestfish/#content</a></p>

</li>
<li><p>Find out which files were last updated in a guest:</p>

<p><a href="https://rwmj.wordpress.com/2012/02/27/using-libguestfs-to-find-out-why-a-windows-guest-was-hanging/#content">https://rwmj.wordpress.com/2012/02/27/using-libguestfs-to-find-out-why-a-windows-guest-was-hanging/#content</a></p>

<p>This might give you a clue as to what program is running.</p>

</li>
</ol>

<h1 id="hex-dumping-sectors-from-the-guest">Hex-dumping sectors from the guest</h1>

<p>Hex-dump the boot partition (Master Boot Record / first sector):</p>

<pre><code> guestfish --ro -a disk.img run : pread-device /dev/sda 0x200 0 |
   hexdump -C</code></pre>

<p>(<code>0x200</code> = 512 bytes which is the size of traditional PC sectors)</p>

<p>To hexdump the N&#39;th partition, substitute a number for <code>N</code> in the following command:</p>

<pre><code> guestfish --ro -a disk.img \
     run : pread-device /dev/sda 0x200 $((N*0x200)) |
   hexdump -C</code></pre>

<h1 id="hex-editing-sectors-in-the-guest">Hex-editing sectors in the guest</h1>

<p>Hex-edit the boot partition (Master Boot Record / first sector):</p>

<pre><code> guestfish --rw -a disk.img run : hexedit /dev/sda 0x200</code></pre>

<h1 id="install-packages-rpms-debian-packages-in-a-guest">Install packages (RPMs, Debian packages) in a guest</h1>

<p>Since libguestfs 1.26, <a href="virt-builder.1.html">virt-builder(1)</a>, <a href="virt-customize.1.html">virt-customize(1)</a> and <a href="virt-sysprep.1.html">virt-sysprep(1)</a> have an <i>--install</i> option for installing packages in Linux guests. (Use virt-customize if you have an existing guest, or virt-builder if you want to create a guest from scratch).</p>

<p>For example:</p>

<pre><code> virt-builder fedora-20 --install emacs</code></pre>

<h1 id="install-packages-from-an-alternate-repository">Install packages from an alternate repository</h1>

<p>Since libguestfs 1.26, you can use <a href="virt-builder.1.html">virt-builder(1)</a>, <a href="virt-customize.1.html">virt-customize(1)</a> or <a href="virt-sysprep.1.html">virt-sysprep(1)</a> <i>--edit</i> option to edit repository metadata before installing packages</p>

<p>For example this would install packages from the updates-testing repository in Fedora:</p>

<pre><code> virt-builder fedora-20 \
   --edit &#39;/etc/yum.repos.d/fedora-updates-testing.repo:
             s/enabled=0/enabled=1/&#39; \
   --install emacs</code></pre>

<h1 id="install-syslinux-bootloader-in-a-guest">Install SYSLINUX bootloader in a guest</h1>

<p>SYSLINUX is a small, easy to configure bootloader for Linux and Windows guests. If your guest is not bootable, you can install the SYSLINUX bootloader using either the guestfish commands <code>syslinux</code> (for FAT-based guests) or <code>extlinux</code> (for ext2/3/4 and btrfs-based guests).</p>

<p>This guide assumes a Linux guest where <i>/dev/sda1</i> is <i>/boot</i>, <i>/boot/vmlinuz</i> is the guest kernel, and <i>/dev/sda3</i> is the root partition. For a Windows guest you would need a FAT-formatted boot partition and you would need to use the <code>syslinux</code> command instead.</p>

<p>Create a <i>syslinux.cfg</i> configuration file. You should check the SYSLINUX documentation at <a href="http://www.syslinux.org">http://www.syslinux.org</a> but it may look something like this:</p>

<pre><code> DEFAULT linux
 LABEL linux
   SAY Booting the kernel
   KERNEL vmlinuz
   INITRD initrd
   APPEND ro root=/dev/sda3</code></pre>

<p>Locate the syslinux master boot record (a file called something like <i>/usr/share/syslinux/mbr.bin</i>).</p>

<pre><code> guestfish -a disk.img -i
 # Upload the master boot record and configuration file:
 &gt;&lt;fs&gt; upload ..../mbr.bin /boot/mbr.bin
 &gt;&lt;fs&gt; upload ..../syslinux.cfg /boot/syslinux.cfg
 # Put the MBR into the boot sector:
 &gt;&lt;fs&gt; copy-file-to-device /boot/mbr.bin /dev/sda size:440
 # Install syslinux on the first partition:
 &gt;&lt;fs&gt; extlinux /boot
 # Set the first partition as bootable:
 &gt;&lt;fs&gt; part-set-bootable /dev/sda 1 true</code></pre>

<p>See also: <a href="http://rwmj.wordpress.com/2013/04/04/new-in-libguestfs-use-syslinux-or-extlinux-to-make-bootable-guests/#content">http://rwmj.wordpress.com/2013/04/04/new-in-libguestfs-use-syslinux-or-extlinux-to-make-bootable-guests/#content</a></p>

<h1 id="list-applications-installed-in-a-vm">List applications installed in a VM</h1>

<p>Save the following to a file <i>list-apps.sh</i>:</p>

<pre><code> #!/bin/sh -
 set -e
 eval &quot;$(guestfish --ro -d &quot;$1&quot; --i --listen)&quot;
 root=&quot;$(guestfish --remote inspect-get-roots)&quot;
 guestfish --remote inspect-list-applications &quot;$root&quot;
 guestfish --remote exit</code></pre>

<p>Make the file executable and then you can run it on any named virtual machine:</p>

<pre><code> # list-apps.sh WinGuest
 [0] = {
   app_name: Mozilla Firefox (3.6.12)
   app_display_name: Mozilla Firefox (3.6.12)
   app_epoch: 0
   app_version: 3.6.12 (en-GB)
   app_release:
   app_install_path: C:\Program Files\Mozilla Firefox
   app_trans_path:
   app_publisher: Mozilla
   app_url: http://www.mozilla.com/en-GB/
   app_source_package:
   app_summary:
   app_description: Mozilla Firefox
 }
 [1] = {
   app_name: VLC media player
   app_display_name: VLC media player 1.1.5
   app_epoch: 0
   app_version: 1.1.5
   app_release:
   app_install_path: C:\Program Files\VideoLAN\VLC
   app_trans_path:
   app_publisher: VideoLAN
   app_url: http://www.videolan.org/
   app_source_package:
   app_summary:
   app_description:
 }</code></pre>

<p>If you want to run the script on disk images (instead of libvirt virtual machines), change <code>-d &quot;$1&quot;</code> to <code>-a &quot;$1&quot;</code>. See also <a href="virt-inspector.1.html">virt-inspector(1)</a>.</p>

<h1 id="list-files-and-directories-in-a-vm">List files and directories in a VM</h1>

<p>Use <a href="virt-ls.1.html">virt-ls(1)</a>.</p>

<h1 id="list-services-in-a-windows-vm">List services in a Windows VM</h1>

<p>The link below contains a script that can be used to list out the services from a Windows VM, and whether those services run at boot time or are loaded on demand.</p>

<p><a href="https://rwmj.wordpress.com/2010/12/10/tip-list-services-in-a-windows-guest/#content">https://rwmj.wordpress.com/2010/12/10/tip-list-services-in-a-windows-guest/#content</a></p>

<h1 id="make-a-disk-image-sparse">Make a disk image sparse</h1>

<p>Use <a href="virt-sparsify.1.html">virt-sparsify(1)</a>.</p>

<h1 id="monitor-disk-usage-over-time">Monitor disk usage over time</h1>

<p>You can use <a href="virt-df.1.html">virt-df(1)</a> to monitor disk usage of your guests over time. The link below contains a guide.</p>

<p><a href="http://virt-tools.org/learning/advanced-virt-df/">http://virt-tools.org/learning/advanced-virt-df/</a></p>

<h1 id="reading-the-windows-event-log-from-windows-vista-or-later-">Reading the Windows Event Log from Windows Vista (or later)</h1>

<p><a href="guestfish.1.html">guestfish(1)</a> plus the tools described in the link below can be used to read out the Windows Event Log from any virtual machine running Windows Vista or a later version.</p>

<p><a href="https://rwmj.wordpress.com/2011/04/17/decoding-the-windows-event-log-using-guestfish/#content">https://rwmj.wordpress.com/2011/04/17/decoding-the-windows-event-log-using-guestfish/#content</a></p>

<h1 id="remove-root-password-linux-">Remove root password (Linux)</h1>

<p>Using the <a href="virt-edit.1.html">virt-edit(1)</a> <i>-e</i> option you can do simple replacements on files. One use is to remove the root password from a Linux guest:</p>

<pre><code> virt-edit -d domname /etc/passwd -e &#39;s/^root:.*?:/root::/&#39;

 virt-edit -a disk.img /etc/passwd -e &#39;s/^root:.*?:/root::/&#39;</code></pre>

<h1 id="remove-administrator-password-windows-">Remove Administrator password (Windows)</h1>

<p>The link below contains one technique for removing the Administrator password from a Windows VM, or to be more precise, it gives you a command prompt the next time you log in which you can use to bypass any security:</p>

<p><a href="https://mdbooth.wordpress.com/2010/10/18/resetting-a-windows-guests-administrator-password-with-guestfish/">https://mdbooth.wordpress.com/2010/10/18/resetting-a-windows-guests-administrator-password-with-guestfish/</a></p>

<h1 id="sysprepping-a-virtual-machine-windows-">Sysprepping a virtual machine (Windows)</h1>

<p>It is possible to do a &quot;sysprep&quot; using libguestfs alone, although not straightforward. Currently there is code in the Aeolus Oz project which does this (using libguestfs). It is likely we will add this to <a href="virt-sysprep.1.html">virt-sysprep(1)</a> in future.</p>

<p><a href="https://github.com/clalancette/oz">https://github.com/clalancette/oz</a> <a href="https://www.redhat.com/archives/virt-tools-list/2011-May/msg00019.html">https://www.redhat.com/archives/virt-tools-list/2011-May/msg00019.html</a></p>

<h1 id="unpack-a-live-cd">Unpack a live CD</h1>

<p>Linux live CDs often contain multiple layers of disk images wrapped like a Russian doll. You can use <a href="guestfish.1.html">guestfish(1)</a> to look inside these multiple layers, as outlined in the guide below.</p>

<p><a href="https://rwmj.wordpress.com/2009/07/15/unpack-the-russian-doll-of-a-f11-live-cd/#content">https://rwmj.wordpress.com/2009/07/15/unpack-the-russian-doll-of-a-f11-live-cd/#content</a></p>

<h1 id="uploading-and-downloading-files">Uploading and downloading files</h1>

<p>The link below contains general tips on uploading (copying in) and downloading (copying out) files from VMs.</p>

<p><a href="https://rwmj.wordpress.com/2010/12/02/tip-uploading-and-downloading/#content">https://rwmj.wordpress.com/2010/12/02/tip-uploading-and-downloading/#content</a></p>

<h1 id="uploading-raw-filesystem-content">Uploading raw filesystem content</h1>

<p>You can use <a href="guestfish.1.html">guestfish(1)</a> to upload whole filesystems into a VM, even into a filesystem which is encrypted or buried inside an LV or RAID device:</p>

<pre><code> guestfish --rw -a disk.img run : upload sda1.img /dev/sda1

 guestfish --rw -d Guest run : upload lv.img /dev/vg_guest/lv_root</code></pre>

<p>One common problem is that the filesystem isn&#39;t the right size for the target. If it is too large, there&#39;s not much you can do with libguestfs - you have to prepare the filesystem differently. But if the filesystem needs to expand into the target, you can use guestfish to resize it to the right size:</p>

<pre><code> guestfish --rw -d Guest run : \
   upload lv.img /dev/vg_guest/lv_root : \
   resize2fs /dev/vg_guest/lv_root</code></pre>

<p>(or use <code>ntfsresize</code> if the filesystem is NTFS).</p>

<h1 id="use-libguestfs-tools-on-vmware-esx-guests">Use libguestfs tools on VMware ESX guests</h1>

<p>The link below explains how to use libguestfs, <a href="guestfish.1.html">guestfish(1)</a> and the virt tools on any VMware ESX guests, by first sharing the VMware VMFS over sshfs.</p>

<p><a href="https://rwmj.wordpress.com/2011/05/10/tip-use-libguestfs-on-vmware-esx-guests/#content">https://rwmj.wordpress.com/2011/05/10/tip-use-libguestfs-on-vmware-esx-guests/#content</a></p>

<h1 id="see-also">SEE ALSO</h1>

<p><a href="guestfs.3.html">guestfs(3)</a>, <a href="guestfish.1.html">guestfish(1)</a>, <a href="guestfs-examples.3.html">guestfs-examples(3)</a>, <a href="guestfs-erlang.3.html">guestfs-erlang(3)</a>, <a href="guestfs-golang.3.html">guestfs-golang(3)</a>, <a href="guestfs-java.3.html">guestfs-java(3)</a>, <a href="guestfs-lua.3.html">guestfs-lua(3)</a>, <a href="guestfs-ocaml.3.html">guestfs-ocaml(3)</a>, <a href="guestfs-perl.3.html">guestfs-perl(3)</a>, <a href="guestfs-python.3.html">guestfs-python(3)</a>, <a href="guestfs-ruby.3.html">guestfs-ruby(3)</a>, <a href="http://libguestfs.org/">http://libguestfs.org/</a>.</p>

<h1 id="authors">AUTHORS</h1>

<p>Richard W.M. Jones (<code>rjones at redhat dot com</code>)</p>

<h1 id="copyright">COPYRIGHT</h1>

<p>Copyright (C) 2009-2015 Red Hat Inc.</p>

<h1 id="license">LICENSE</h1>

<p>This manual page contains examples which we hope you will use in your programs. The examples may be freely copied, modified and distributed for any purpose without any restrictions.</p>

<h1 id="bugs">BUGS</h1>

<p>To get a list of bugs against libguestfs, use this link: <a href="https://bugzilla.redhat.com/buglist.cgi?component=libguestfs&amp;product=Virtualization+Tools">https://bugzilla.redhat.com/buglist.cgi?component=libguestfs&amp;product=Virtualization+Tools</a></p>

<p>To report a new bug against libguestfs, use this link: <a href="https://bugzilla.redhat.com/enter_bug.cgi?component=libguestfs&amp;product=Virtualization+Tools">https://bugzilla.redhat.com/enter_bug.cgi?component=libguestfs&amp;product=Virtualization+Tools</a></p>

<p>When reporting a bug, please supply:</p>

<ul>

<li><p>The version of libguestfs.</p>

</li>
<li><p>Where you got libguestfs (eg. which Linux distro, compiled from source, etc)</p>

</li>
<li><p>Describe the bug accurately and give a way to reproduce it.</p>

</li>
<li><p>Run <a href="libguestfs-test-tool.1.html">libguestfs-test-tool(1)</a> and paste the <b>complete, unedited</b> output into the bug report.</p>

</li>
</ul>

</body>
</html>

